
<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <meta name="keywords" content="HTML,CSS,JavaScript,THREE.js">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kronologia</title>
    <style>
      .tick line{
        visibility:hidden;
      }
      path.domain{
        stroke:#ccc;
      }
      .popup {
        position:fixed;
        text-align:left;
        z-index:9999;
        margin:auto;
        clear:both;
        height:fit-content;
        width:600px;
        padding: 20px 20px 3rem;
        left:0;
        right:0;
        top:0;
        bottom:0;
        box-shadow:0px 0px 10px rgba(0, 0, 0, 0.3);
        background:#fff;
        opacity:0;
        transition: 0.5s ease all;
        pointer-events: none;
      }

      .popup-show{
        opacity:1;
        transition: 0.5s ease all;
      }

      #popup_title{
        font-size: 40px;
        margin-bottom: 1rem;
      }

      #popup_authorName {
        font-size: 20px;
        margin-bottom: 2rem;
      }

      .popup_abstract_title{
        font-size: 20px;
        margin-bottom: 0.5rem;
        border-bottom: solid 1px gray;
      }

      .popup_abstract_paragraph{
        font-size: 16px;
        margin-top:0;
      }


    </style>
  </head>
  <body>
    <div id="container" style="position:relative;">
      <div id="img-tooltip" style="position:absolute;font-size:30px;font-weight:700; background-color:rgba(255,255,255,0.5); padding:10px; border:2px #000 solid; opacity:0;"></div>
      <div id="dot-tooltip" style="position:absolute;font-size:30px;font-weight:700; background-color:rgba(255,255,255,0.5); padding:10px; border:2px #000 solid; opacity:0;"></div>
      <div class="popup">
        <div id="popup_title"></div>
        <div id="popup_authorName">Author Name</div>
        <div class="popup_abstract">
          <h3 class="popup_abstract_title">Abstract</h3>
          <p class="popup_abstract_paragraph">
            Abstract Paragraph Abstract Paragraph Abstract Paragraph Abstract Paragraph
          </p>
        </div> 
      </div>
      <svg>
        <g class="graph">
          <g class="images-group"></g>
          <g class="line-charts-groups"></g>
        </g>
      </svg>
    </div>
    <button id="generate">Save as SVG</button>
    <script type="text/javascript"  src="js/d3.v5.min.js"></script>
    <script type="text/javascript"  src="js/blob.js"></script>
    <script type="text/javascript"  src="js/fileSaver.js"></script>
    <script>
      var filepath = "images/lkbk/";
      var margin = {top: 30, right: 0, bottom: 20, left: 20},
        width = window.innerWidth - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom,
        height2 = height+450, // line chart
        height3 = height2+1500, // dots
        resizeScale = 1.3,
        bookGap = 15,
        bookHeight = 66,
        bookWidth = 50;

      var x = d3.scaleLinear().range([0, width]);
      var y = d3.scaleLinear().range([(bookHeight+bookGap) * 2 * resizeScale, height-50]);
      var y2 = d3.scaleLog().range([height2, height+100]);
      var ySize = d3.scaleLog().range([3, 12]);
      var yLine = d3.scaleLinear().range([height2, height+100]);
      var yLine2 = d3.scaleLinear().range([height2, height+100]);
      var y3 = d3.scaleLinear().range([height2+50, height3]);

      var line = d3.line()
        .x(function(d) {return x(d.key); })
        .y(function(d) { return yLine(d.value.papers); })
        .curve(d3.curveCatmullRom);
      var line2 = d3.line()
        .x(function(d) {return x(d.key); })
        .y(function(d) { return yLine2(d.value.people); })
        .curve(d3.curveCatmullRom);
      var lineGenerator = d3.line()
        .x(function(d){return d.x})
        .y(function(d){return d.y})
        .curve(d3.curveCatmullRom);

      var svg = d3.select("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height3 + margin.top + margin.bottom)
          
      var graph = d3.select(".graph")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
      var imagesGroup = d3.select(".images-group")
      var linesGroup = d3.select(".line-charts-groups")
      var defs = graph.append('svg:defs');
      var data = [];
      var data2 = {};
      var data3 = {};
      var data4 = {};
      var authTracks = {};
      var yearly = {};
      var selected;
      var colors ={"s":"#FFBEBC","p":"#AFCBFF","c":"#AFF8DB","v":"#ffde8a", "a":"#ffc499", "pv":"#ff5484"};
      d3.json("data/LaszloCareer2020.json?v=2").then(function(pdata) {
        d3.json("data/collab.json").then(function(qdata) {
          var ys = {};
          pdata.forEach(function(d) {
              if(d.ctotal!=null && d.authors!=null && d.title!=null && d.year!=null){
                var a = {};
                a.title = d.title;
                a.year = +d.year;
                a.citations = +d.ctotal;
                if(d.authors !=undefined){
                  a.authors = d.authors.split(" and ");
                }
                if(d.img!=undefined){
                  a.img = d.img;
                  if(ys[+d.year]==undefined){
                    ys[+d.year] = 0;
                  }else{
                    ys[+d.year]+=1;
                  }
                  var ny;
                  if(d.ctotal<0){
                    ny = -1;
                  }else{
                    ny = ys[+d.year];
                  }
                  data3[d.img] = {"x":+d.year,"y":ny,"t":d.title};
                }
                if(d.cover !=undefined){
                  data4[d.cover] = {"x":+d.year,"t":d.title};
                }
                data.push(a);
              }
          });

          data2 = qdata;

          // x.domain(d3.extent(data, function(d) { return d.year; }));
          x.domain([1988,2021]);
          y2.domain([1, d3.max(data, function(d) { return d.citations; })]);
          ySize.domain([1, d3.max(data, function(d) { return d.citations; })]);
          y.domain([d3.max(d3.entries(data3),function(d){return d.value.y}),0]);

          //draw paper scatter plot time vs impact on top
          linesGroup.selectAll("dot")
              .data(data)
            .enter().append("circle")
              .attr("r", 2)
              .attr("cx", function(d) { return x(d.year); })
              .attr("cy", function(d) {
                if(Number.isNaN(d.citations) == true || d.citations == undefined)
                {return 1;}
                else{return y2(d.citations)};
              })
              .style("fill",function(d){return "#ccc";})
              .attr("class","paper")
              .attr("title",function(d){return d.title})
              .attr("id",function(d){
                if(d.title!=undefined){
                  var id = titleToId(d.title);
                  return id;
                }
              });



          for(t=x.domain()[0];t<x.domain()[1];t++){
              yearly[t] = {};
              var cownt = 0;
              var ac = 0;
              for(d in data){
                if(data[d].year == t){
                  cownt++;
                  ac+=data[d].authors.length;
                }
              }
            console.log(cownt,ac);
            yearly[t]["papers"] = cownt;
            yearly[t]["people"] = ac;
          }
          yLine.domain([0,30]);
          yLine2.domain([0,375]);

          //draw lines for impact and collab count
          linesGroup.append("path")
          .datum(d3.entries(yearly))
          .attr("class","line")
          .attr("d",line)
          .style("fill","none")
          .style("stroke", "#000")
          .style("stroke-width",2);

          linesGroup.append("path")
          .datum(d3.entries(yearly))
          .attr("class","line")
          .attr("d",line2)
          .style("fill","none")
          .style("stroke", function(){return getRandomColor();})
          .style("stroke-width",2);

          imagesGroup.append("line")
           .attr("x1",function(d) { return x(1990); })
           .attr("x2",function(d) { return x(2020);})
           .attr("y1",function(d) { return (bookHeight+bookGap) * resizeScale + bookGap; })
           .attr("y2",function(d) { return (bookHeight+bookGap) * resizeScale + bookGap; })
           .attr("stroke","#000")
           .attr("stroke-width",1)
           .attr("fill","none")
           .style("stroke-dasharray", ("3, 3"));

          imagesGroup.append("line")
            .attr("x1",function(d) { return x(1990); })
            .attr("x2",function(d) { return x(2020);})
            .attr("y1",function(d) { return (bookHeight+bookGap) * 2 * resizeScale + bookGap * 2; })
            .attr("y2",function(d) { return  (bookHeight+bookGap) * 2 * resizeScale + bookGap * 2; })
            .attr("stroke","#000")
            .attr("stroke-width",1)
            .attr("fill","none")
            .style("stroke-dasharray", ("3, 3"));

          imagesGroup.selectAll(".books-and-pics")
          .data(d3.entries(data3))
          .enter().append("rect")
          .attr("class", "books-and-pics")
          .attr("x", function(d) {return x(d.value.x)-50})
          .attr("y",function(d) { if(d.value.y<0){return  (bookHeight+bookGap) * resizeScale + bookGap * 2;} else{return y(d.value.y) + bookGap * 3}})
          .attr("width", bookWidth * resizeScale)
          .attr("height",function(d){if(d.value.y<0){return bookHeight * resizeScale} else{return bookWidth * resizeScale;}})
          .attr("title",function(d){return d.value.t})
          .style("cursor", "pointer")
          .style("fill", "#000")
          .style("stroke","#eee")
          .style("fill",function(d){
            var h = 50 * resizeScale;
            var r = 50 * resizeScale;
            if(d.value.y<0){h = 66 * resizeScale;}
            imgToDefs(d.key,d.key,r,h)
            return "url(#"+d.key+"img)";
          })
          .on("mouseover",function(d){
            const mouseX = d3.event.pageX;
            const mouseY = d3.event.pageY;
      
            d3.selectAll("#"+titleToId(d.value.t)).attr("stroke","#000").attr("stroke-width",2);
            d3.select("#img-tooltip").append("text").text(function(){return d.value.t});
            d3.select("#img-tooltip").style("left", `${mouseX}px`).style("top", `${mouseY}px`).transition().duration(500).style("opacity",1);
            
           
          })
          .on("click", function(d){
             var popup = document.getElementsByClassName("popup")[0];
            
            if(typeof popup !== null && popup !== 'undefined' ){
                  popup.classList.add("popup-show");
              }
            const title = d.value.t;
            d3.select("#popup_title").html(d.value.t);
            d3.selectAll("#"+titleToId(d.value.t)).attr("stroke","none");
            d3.select("#img-tooltip").transition().style("opacity",0);
            d3.select("#img-tooltip").html("");
          })
          .on("mouseout",function(d){
            d3.selectAll("#"+titleToId(d.value.t)).attr("stroke","none");
            d3.select("#img-tooltip").transition().style("opacity",0);
            d3.select("#img-tooltip").html("");
            var popup = document.getElementsByClassName("popup")[0];
            
            if(typeof popup !== null && popup !== 'undefined' ){
                  popup.classList.remove("popup-show");
              }
          });

          imagesGroup.selectAll(".journal")
          .data(d3.entries(data4))
          .enter().append("rect")
          .attr("class", "journal")
          .attr("x", function(d) {return x(d.value.x)-50})
          .attr("y", bookGap)
          .attr("width",function(d){return bookWidth * resizeScale;})
          .attr("height", bookHeight * resizeScale)
          .attr("title",function(d){return d.value.t})
          .style("cursor", "pointer")
          .style("fill", "#000")
          .style("stroke","#eee")
          .style("fill",function(d){
            var r = 50 * resizeScale;
            var h = 66 * resizeScale;
            imgToDefs(d.key,d.key,r,h);
            return "url(#"+d.key+"img)";
          })
          .on("mouseover",function(d){
            const mouseX = d3.event.pageX;
            const mouseY = d3.event.pageY;
            d3.selectAll("#"+titleToId(d.value.t)).attr("stroke","#000").attr("stroke-width",2);
            d3.select("#img-tooltip").append("text").text(function(){return d.value.t});
            d3.select("#img-tooltip").style("left", `${mouseX}px`).style("top", `${mouseY}px`).transition().duration(500).style("opacity",1);
          })
          .on("click", function(d){
             var popup = document.getElementsByClassName("popup")[0];
            
            if(typeof popup !== null && popup !== 'undefined' ){
                  popup.classList.add("popup-show");
              }
            const title = d.value.t;
            d3.select("#popup_title").html(d.value.t);
            d3.selectAll("#"+titleToId(d.value.t)).attr("stroke","none");
            d3.select("#img-tooltip").transition().style("opacity",0);
            d3.select("#img-tooltip").html("");
          })
          .on("mouseout",function(d){
            d3.selectAll("#"+titleToId(d.value.t)).attr("stroke","none");
            d3.select("#img-tooltip").transition().style("opacity",0);
            d3.select("#img-tooltip").html("");
            var popup = document.getElementsByClassName("popup")[0];
            
            if(typeof popup !== null && popup !== 'undefined' ){
                  popup.classList.remove("popup-show");
              }
          });

          //get time data for collaborator timeline, cross with publication data
          var count = 0;
          var tempA = {};
          for(j=0;j<data.length;j++){
            if(data[j].authors!= undefined && data[j].authors!= null){
              var yr = data[j].year;
              for(i=0;i<data[j].authors.length;i++){
              // for(i=0;i<10;i++){
                var au = data[j].authors[i];
                if(au!=undefined && au.includes("Albertlaszlo") == false && au.includes("Albert-") == false && data2[au]!=undefined){
                  if(data2[au].status != "c" && data2[au].status != "" && data2[au].status != "x" && data2[au].status != "n" && data2[au].status != "a"){
                    if(authTracks[au]==undefined){
                      if( Number.isNaN(yr) == false && Number.isNaN(data[j].citations) == false && yr!=1970){
                        count++;
                        tempA[au] = count;
                        authTracks[au] = [];
                        authTracks[au].push({"x":yr,"y":data[j].citations, "ix":count, "t":data[j].title});
                      }
                    }else{
                      var result = authTracks[au].filter(obj => {if (obj.x === yr){obj.w++;return obj.x === yr;}});
                      if(result.length == 0){
                        if( Number.isNaN(yr) == false && Number.isNaN(data[j].citations) == false && yr!=1970){
                          authTracks[au].push({"x":yr,"y":data[j].citations, "ix":tempA[au], "t":data[j].title});
                        }
                      }
                    }
                   }//if status
                }
              }
            }
          }

          var tempB = Object.keys(tempA);
          //sort by longest range
          //tempB.sort((a, b) => ((authTracks[a][authTracks[a].length-1].x - authTracks[a][0].x) > (authTracks[b][authTracks[b].length-1].x - authTracks[b][0].x)) ? 1 : -1);
          //sort by earliest appearance in timeline
          tempB.sort((a, b) => (authTracks[a][0].x > authTracks[b][0].x) ? 1 : -1);
          //sort by number of publications
          // tempB.sort((a, b) => (authTracks[a].length < authTracks[b].length) ? 1 : -1);
          // console.log(tempB)
          // var uu = [];
          //   for(z=0;z<tempB.length;z++){
          //     var u = unicodeLiteral(tempB[z]);
          //     uu.push(u)
          //   }
          // console.log(uu);

          y3.domain([1, Object.keys(authTracks).length]);
          for(auth in authTracks) {
            var c = getRandomColor();
            var status = colors[data2[auth].status];
            // if(authTracks[auth].length > 1){
              authTracks[auth].sort((a, b) => (a.x > b.x) ? 1 : -1);

              //draw collaborator bars
              linesGroup.append("rect")
              .attr("x",function(){return x(authTracks[auth][0].x)})
              .attr("y",function(){return y3(tempB.indexOf(auth))})
              .attr("width",function(){
                var l = authTracks[auth].length-1;
                return x((authTracks[auth][l].x)) - x((authTracks[auth][0].x))+2
              })
              .attr("height",2)
              .attr("fill", status);
            // }

            //append nodes
            linesGroup.selectAll("dot")
              .data(authTracks[auth])
            .enter().append("circle")
              .attr("title",function(d){return d.t})
              .attr("class",function(d){
                if(d.t!=undefined){
                  var t = titleToId(d.t);
                  return `paper-node ${t}`;
                }else{
                  return `paper-node ${auth+d.x}`;
                }})
              .attr("r", function(d){if(d.y == 0){return 3;}else {return ySize(d.y);}})
              .attr("cx", function(d) { return x(d.x); })
              .attr("cy", function(d) {return y3(tempB.indexOf(auth))+1; })
              .on('mouseover', function(d){
                let selected;
                if (d.t != undefined){
                  selected = titleToId(d.t)
                } else {
                  selected = auth+d.x;
                }
                var cx = x(d.x)+80;
                var cy = d3.select(this).attr("cy")
                d3.selectAll("."+selected).style("stroke", "#000")
                d3.select("#dot-tooltip").append("text").text(function(){return d.t;});
                d3.select("#dot-tooltip").style("left",`${cx}px`).style("top", `${cy}px`).style("opacity",1);
              })
              .on('mouseout', function(d){
                d3.selectAll(".paper-node").style("stroke", "none");
                d3.select("#dot-tooltip").style("opacity",0);
                d3.select("#dot-tooltip").html("");
              })
              .style("fill",status)
              .style("stroke",status);

              //add collaborator names
            // if(authTracks[auth].length > 1){
              var l = authTracks[auth].length-1;
              linesGroup.append("text")
                .attr("x", function(){return x(authTracks[auth][0].x)-15})
                // .attr("x",function(){
                //   var l = authTracks[auth].length-1;
                //   var f = x(authTracks[auth][0].x);
                //   var e = x(authTracks[auth][l].x);
                //   return ((x(e)-x(f)+1)/2)+f;
                // })
                .attr("y", function(){return y3(tempB.indexOf(auth))+3})
                .text(function(){return auth})
                .attr("text-anchor","end")
                .attr("font-size", 12);
            // }
          }

          linesGroup.append("g")
              .attr("transform", "translate(0," + height2 + ")")
              .call(d3.axisBottom(x).tickFormat(d => d));
          linesGroup.append("g")
              .attr("transform", "translate(0," + -20 + ")")
              .call(d3.axisBottom(x).tickFormat(d => d));
          linesGroup.append("g")
                  .attr("transform", "translate(0," + height3 + ")")
                  .call(d3.axisBottom(x).tickFormat(d => d));
        });
      });

      /* Creates a uppercase hex number with at least length digits from a given number */
      function fixedHex(number, length){
          var str = number.toString(16).toUpperCase();
          while(str.length < length)
              str = "0" + str;
          return str;
      }

      /* Creates a unicode literal based on the string */
      function unicodeLiteral(str){
          var i;
          var result = "";
          for( i = 0; i < str.length; ++i){
              /* You should probably replace this by an isASCII test */
              if(str.charCodeAt(i) > 126 || str.charCodeAt(i) < 32)
                  result += "\\u" + fixedHex(str.charCodeAt(i),4);
              else
                  result += str[i];
          }

          return result;
      }

      function getRandomColor() {
        var letters = 'ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 6)];
        }
        return color;
      }

      function titleToId(title){
        var t = title.replace(/ /g,"-").toLowerCase();
        t=t.replace(/:/g,"-");
        t=t.replace(/\?/g,"-");
        t=t.replace(/\//g,"-");
        t=t.replace(/'/g,"-");
        t=t.replace(/,/g,"-");
        t=t.replace(/\./g,"");
        t=t.replace(/\(/g,"-");
        t=t.replace(/\)/g,"-");
        return t;
      }

      function imgToDefs(img,id,r,h){
        defs.append("svg:pattern")
        .attr("id", id+"img")
        .attr("width", 1)
        .attr("height", function(){return 1*(h/r);})
        // .attr("patternUnits", "userSpaceOnUse")
        .append("svg:image")
        .attr("xlink:href", filepath+img)
        .attr("width", r)
        .attr("height", h)
        .attr("x", 0)
        .attr("y", 0);
      }

      d3.select("#generate")
          .on("click", writeDownloadLink);
      function writeDownloadLink(){
          try {
              var isFileSaverSupported = !!new Blob();
          } catch (e) {
              alert("blob not supported");
          }
          var html = graph
              .attr("title", "test2")
              .attr("version", 1.1)
              .attr("xmlns", "http://www.w3.org/2000/svg")
              .node().outerHTML;
          var blob = new Blob([html], {type: "image/svg+xml"});
          saveAs(blob, "viz.svg");
      };
    </script>
  </body>
</html>
