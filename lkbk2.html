<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <meta name="keywords" content="HTML,CSS,JavaScript,THREE.js">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kronologia</title>
    <style>
      html{
        background-color: rgba(255,255,255,1);
        color: #000;
        font-family: Arial, Helvetica, sans-serif;
      }
      .tick line{
        visibility:hidden;
      }
      path.domain{
        stroke:#ccc;
      }

      .tooltip, .popup{
        color: rgba(0,0,0,0.9);
      }

      .popup {
        position:fixed;
        text-align:left;
        z-index:9999;
        margin:auto;
        clear:both;
        height:fit-content;
        width:600px;
        padding: 20px 20px 3rem;
        left:0;
        right:0;
        top:0;
        bottom:0;
        box-shadow:0px 0px 10px rgba(0,0,0,0.5);
        background:#fff;
        opacity:0;
        transition: 0.5s ease all;
        pointer-events: none;
      }

      .popup-show{
        opacity:1;
        transition: 0.5s ease all;
      }

      #popup_title{
        font-size: 40px;
        margin-bottom: 1rem;
      }

      #popup_authorName {
        font-size: 20px;
        margin-bottom: 2rem;
      }

      #popup_img_container{
        text-align:center;
      }

      #popup_img {
        width: 60%;
        height: auto;
      }

      .popup_abstract_title{
        font-size: 20px;
        margin-bottom: 0.5rem;
        border-bottom: solid 1px gray;
      }

      .popup_abstract_paragraph{
        font-size: 16px;
        margin-top:0;
      }

      .paper, .collab-node {
        cursor: pointer;
      }
/* 
      .shadow {
        -webkit-filter: drop-shadow( 0px 0px 10px rgba(255, 255, 255, 1));
        filter: drop-shadow( 0px 0px 10px rgba(255, 255, 255, 1));
      } */


    </style>
  </head>
  <body>
    <div id="container" style="position:relative;">
      <div class="tooltip" id="title-tooltip" style="position:absolute;font-size:30px;font-weight:700; background-color:rgba(255,255,255,1); padding:10px; opacity:0;"></div>
      <div class="tooltip" id="dot-tooltip" style="position:absolute;font-size:30px;font-weight:700; background-color:rgba(255,255,255,1); padding:10px; opacity:0;"></div>
      <div class="popup">
        <div id="popup_title"></div>
        <div id="popup_authorName">Author Name</div>
        <div id="popup_img_container">
          <img id="popup_img">
        </div>
        <div class="popup_abstract">
          <h3 class="popup_abstract_title">Abstract</h3>
          <p id="popup_abstract_paragraph">
            
          </p>
        </div> 
      </div>
      <svg>
        <g class="graph">
          <g class="images-group"></g>
          <g class="line-charts-groups"></g>
        </g>
      </svg>
    </div>
    <!-- <button id="generate">Save as SVG</button> -->
    <script type="text/javascript"  src="js/d3.v5.min.js"></script>
    <script type="text/javascript"  src="js/blob.js"></script>
    <script type="text/javascript"  src="js/fileSaver.js"></script>
    <script>
      var filepath = "images/lkbk/";
      var margin = {top: 30, right: 0, bottom: 20, left: 20},
        width = window.innerWidth - margin.left - margin.right,
        height = 550 - margin.top - margin.bottom,
        height2 = height+300, // line chart
        height3 = height2+900, // dots
        height4 = height3+400, // for journals and books
        resizeScale = 1.2,
        bookGap = 15,
        bookHeight = 66,
        bookWidth = 50,
        regR = 3,
        selR = 10,
        imgRegOpac = 1,
        scatterDotRegOpac = 0.5,
        lineRegOpac = 0.8;

      var svg = d3.select("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height4 + margin.top + margin.bottom)
      var graph = d3.select(".graph")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
      var defs = graph.append('svg:defs');
      var imagesGroup = d3.select(".images-group")
      var linesGroup = d3.select(".line-charts-groups")

      var x = d3.scaleLinear().range([0, width]);
      var y = d3.scaleLinear().range([(bookHeight+bookGap) * 2 * resizeScale, height-50]); //images y
      var y = d3.scaleLinear().range([0, height-50])
      var y2 = d3.scaleLog().range([height2, height+25]); // paper dot plot y
      // var y2 = d3.scaleLog().range([height2, 0]); // paper dot plot y
      var ySize = d3.scaleLog().range([2, 6]); // collaborator timeline dots size
      var yLine = d3.scaleLinear().range([height2, height+25]); // line chart1
      var yLine2 = d3.scaleLinear().range([height2, height+25]); // line chart2
      var y3 = d3.scaleLinear().range([height2+50, height3]); // collaborator timeline dots y 
      var y4 = d3.scaleLinear().range([height3+50, height4])

      ////////
      //DATA//
      ////////
      var data = []; // paper (title, authors, citations, year)
      var data2 = {}; // member status with name as key(c, p, s, v, pv..)
      var data3 = {}; // img file name as key (x:year, t:title)
      var data4 = {}; // img file name as key (x:year, t:title)
      var authTracks = {};
      var yearly = {};
      var selected;
      var colors ={"s":"#FFBEBC","p":"#AFCBFF","c":"#AFF8DB","v":"#ffde8a", "a":"#ffc499", "pv":"#ff5484"};
      
      d3.json("data/LaszloCareer2020.json?v=2").then(function(pdata) {
        d3.json("data/collab.json").then(function(qdata) {
          var ys = {};
          pdata.forEach(function(d) {
              if(d.ctotal!=null && d.authors!=null && d.title!=null && d.year!=null){
               
                var a = {};
                a.title = d.title;
                a.year = +d.year;
                a.citations = +d.ctotal;
                if(d.authors !=undefined){
                  a.authors = d.authors.split(" and ");
                }
                if(d.abstract != undefined){
                  a.abstract = d.abstract;
                }
                if(d.img!=undefined){
                  a.img = d.img;
                  if(ys[+d.year]==undefined){
                    ys[+d.year] = 0;
                  }else{
                    ys[+d.year]+=1;
                  }
                  var ny;
                  if(d.ctotal<0){
                    ny = -1;
                  }else{
                    ny = ys[+d.year];
                  }
                  data3[d.img] = {"x":+d.year,"y":ny,"t":d.title};
                }
                if(d.cover !=undefined){
                  data4[d.cover] = {"x":+d.year,"t":d.title};
                }
                data.push(a);
              }
          });
          console.log(data)
          data2 = qdata;
          
          x.domain([1988,2021]);
          y.domain([d3.max(d3.entries(data3),function(d){return d.value.y}),0]); // images
          y2.domain([1, d3.max(data, function(d) { return d.citations; })]); // paper scatter plot
          yLine.domain([0,30]);
          yLine2.domain([0,375]);
          ySize.domain([1, d3.max(data, function(d) { return d.citations; })]); // collaborator timeline dots
          
          
          ///////////////////
          //IMAGES POSITION//
          ///////////////////

          // imagesGroup.append("line")
          //   .attr("x1",function(d) { return x(1990); })
          //   .attr("x2",function(d) { return x(2020);})
          //   .attr("y1",function(d) { return (bookHeight+bookGap) * 2 * resizeScale + bookGap * 2; })
          //   .attr("y2",function(d) { return  (bookHeight+bookGap) * 2 * resizeScale + bookGap * 2; })
          //   .attr("stroke","#000")
          //   .attr("stroke-width",1)
          //   .attr("fill","none")
          //   .style("stroke-dasharray", ("3, 3"));
         
          imagesGroup.selectAll(".books-and-pics")
            .data(d3.entries(data3))
            .enter().append("rect")
            .attr("class",function(d){
                if(d.value.t!=undefined){
                  var id = titleToId(d.value.t);
                  return "books-and-pics " + id+"-img";
                }
              })
            .attr("x", function(d) {return x(d.value.x)-30})
            // .attr("y",function(d) { if(d.value.y<0){return  (bookHeight+bookGap) * resizeScale + bookGap * 2;} else{return y(d.value.y) + bookGap * 3}})
            .attr("y",function(d) { if(d.value.y<0){return height3 + 50 + bookHeight * resizeScale + bookGap * 2 } else{return y(d.value.y) + bookGap}}) 
            .attr("width", bookWidth * resizeScale)
            .attr("height",function(d){if(d.value.y<0){return bookHeight * resizeScale} else{return bookWidth * resizeScale;}})
            // .attr("height",function(d){if(d.value.y<0){return 0} else{return bookWidth * resizeScale;}})
            .attr("title",function(d){return d.value.t})
            .style("cursor", "pointer")
            .style("fill", "#000")
            .style("fill",function(d){
              var h = 50 * resizeScale;
              var r = 50 * resizeScale;
              if(d.value.y<0){h = 66 * resizeScale;}
              imgToDefs(d.key,d.key,r,h)
              return "url(#"+d.key+"img)";
            })
            .attr("opacity", imgRegOpac)
            .on("mouseover",function(d){
              // everything disappear
              d3.selectAll(".books-and-pics").attr("opacity", 0.1)
              d3.selectAll(".journal").attr("opacity", 0.1)
              d3.selectAll(".line").attr("opacity", 0.1)

              // highlight selected img 
              d3.select(this).attr("opacity", 1).attr("stroke","#000").attr("stroke-width",2)
              
              //highlight selected scatter dot (paper)
              const paperCondition = d3.selectAll("."+titleToId(d.value.t)+"-scatter")
              if(paperCondition!=undefined){
                d3.selectAll("."+titleToId(d.value.t)+"-scatter")
                .attr("stroke","#000").attr("stroke-width",2)
                .attr("r", selR).attr("opacity", 1)
              }
              
              // check if authors exist
              const authorCondition = d3.selectAll("."+titleToId(d.value.t)+"-collab-node")["_groups"][0].length
              if (authorCondition != 0){
                // disappear all authors
                d3.selectAll(".collab-rect").attr("opacity", 0.3)
                d3.selectAll(".collab-node").attr("opacity", 0.1)
                d3.selectAll(".author-name").attr("opacity", 0.2)

                // highlight selected authors node
                d3.selectAll("."+titleToId(d.value.t)+"-collab-node")
                .attr("opacity", 1)
                .attr("stroke","black")
                
                // highlight selected authors name
                d3.selectAll("."+titleToId(d.value.t)+"-author-name")
                .attr("opacity", 1).attr("font-size", 15)
              }

              // title tooltip
              const mouseX = d3.event.pageX + 40;
              const mouseY = d3.event.pageY - 25;
              d3.select("#title-tooltip").append("text").text(function(){return d.value.t});
              d3.select("#title-tooltip").style("left", `${mouseX}px`).style("top", `${mouseY}px`).transition().duration(500).style("opacity",1);
              
            })
            .on("click", function(d){

              // disappear title tooltip
              d3.select("#title-tooltip").transition().style("opacity",0);
              d3.select("#title-tooltip").html("");

              var popup = document.getElementsByClassName("popup")[0];
              
              if(typeof popup !== null && popup !== 'undefined' ){
                    popup.classList.add("popup-show");
                }

              const title = d.value.t;
              const selImg = data.filter(d => d.title == title)[0].img;
              const authors = data.filter(d => d.title == title)[0].authors.join(", ");
              const abstract = data.filter(d => d.title == title)[0].abstract;
    
              d3.select("#popup_title").html(d.value.t);
              d3.select("#popup_authorName").html(authors);
              d3.select("#popup_img").attr("src", `${filepath}${selImg}`).attr("opacity","1")
              d3.select("#popup_abstract_paragraph").html(abstract)
              
              
            })
            .on("mouseout",function(d){
              //img
              d3.selectAll(".books-and-pics")
                .attr("opacity", imgRegOpac).attr("stroke", "none")
              d3.selectAll(".journal").attr("opacity", imgRegOpac)
              // line chart
              d3.selectAll(".line").attr("opacity", lineRegOpac)
              // scatter node
              d3.selectAll(".paper")
                .attr("opacity", scatterDotRegOpac)
                .attr("stroke","none")
                .attr("r", regR)
              // authors nodes and rects
              d3.selectAll(".collab-rect")
                .attr("opacity", 1)
              d3.selectAll(".collab-node")
                .attr("opacity", 1)
                .attr("stroke","none")
              //authors name
              d3.selectAll(".author-name")
                .attr("opacity", 1)
                .attr("font-size", 11)
              //disappear tooltip
              d3.select("#title-tooltip").transition().style("opacity",0);
              d3.select("#title-tooltip").html("");

              //disappear popup
              var popup = document.getElementsByClassName("popup")[0];
              
              if(typeof popup !== null && popup !== 'undefined' ){
                    popup.classList.remove("popup-show");
                }
            });

          imagesGroup.selectAll(".journal")
            .data(d3.entries(data4))
            .enter().append("rect")
            .attr("class", "journal")
            .attr("class", function(d){
                if(d.value.t!=undefined){
                  var id = titleToId(d.value.t);
                  return "journal " + id+"-img";
                }
              })
            .attr("x", function(d) {return x(d.value.x)-50})
            .attr("y", height3+50)
            .attr("width",function(d){return bookWidth * resizeScale;})
            .attr("height", bookHeight * resizeScale)
            .attr("title",function(d){return d.value.t})
            .style("cursor", "pointer")
            .style("fill", "#000")
            // .attr("stroke","#000")
            .style("fill",function(d){
              var r = 50 * resizeScale;
              var h = 66 * resizeScale;
              imgToDefs(d.key,d.key,r,h);
              return "url(#"+d.key+"img)";
            })
            .on("mouseover",function(d){
              // everything disappear
              d3.selectAll(".books-and-pics").attr("opacity", 0.1)
              d3.selectAll(".journal").attr("opacity", 0.1)
              d3.selectAll(".line").attr("opacity", 0.1)
              d3.selectAll(".paper").attr("opacity", 0.1) // scatter

              // highlight selected img 
              d3.select(this).attr("opacity", 1).attr("stroke","#000").attr("stroke-width",2)
              
              //highlight selected scatter dot (paper)
              d3.selectAll("."+titleToId(d.value.t)+"-scatter")
                .attr("stroke","#000").attr("stroke-width",2)
                .attr("r", selR).attr("opacity", 1)

              // check if authors exist
              const condition = d3.selectAll("."+titleToId(d.value.t)+"-collab-node")["_groups"][0].length
              if (condition != 0){
                // disappear all authors
                d3.selectAll(".collab-rect").attr("opacity", 0.3)
                d3.selectAll(".collab-node").attr("opacity", 0.1)
                d3.selectAll(".author-name").attr("opacity", 0.2)

                // highlight selected authors node
                d3.selectAll("."+titleToId(d.value.t)+"-collab-node")
                .attr("opacity", 1)
                .attr("stroke","black")
                
                // highlight selected authors name
                d3.selectAll("."+titleToId(d.value.t)+"-author-name")
                .attr("opacity", 1).attr("font-size", 15)
              }

              // title tooltip
              const mouseX = d3.event.pageX + 40;
              const mouseY = d3.event.pageY - 25;
              d3.select("#title-tooltip").append("text").text(function(){return d.value.t});
              d3.select("#title-tooltip").style("left", `${mouseX}px`).style("top", `${mouseY}px`).transition().duration(500).style("opacity",1);
              
            })
            .on("click", function(d){
              // disappear title tooltip
              d3.select("#title-tooltip").transition().style("opacity",0);
              d3.select("#title-tooltip").html("");

              var popup = document.getElementsByClassName("popup")[0];
              
              if(typeof popup !== null && popup !== 'undefined' ){
                    popup.classList.add("popup-show");
                }

              const title = d.value.t;
              const selImg = data.filter(d => d.title == title)[0].cover;
              const authors = data.filter(d => d.title == title)[0].authors.join(", ");
              const abstract = data.filter(d => d.title == title)[0].abstract;

              d3.select("#popup_title").html(d.value.t);
              d3.select("#popup_authorName").html(authors);
              d3.select("#popup_img").attr("src", `${filepath}${selImg}`).attr("opacity","1")
              d3.select("#popup_abstract_paragraph").html(abstract)
            })
            .on("mouseout",function(d){
              //img
              d3.selectAll(".books-and-pics")
                .attr("opacity", imgRegOpac)
              d3.selectAll(".journal")
                .attr("opacity", imgRegOpac)
                .attr("stroke", "none")
                .attr("stroke-width", 0)
                
              // line chart
              d3.selectAll(".line").attr("opacity", lineRegOpac)
              // scatter node
              d3.selectAll(".paper")
                .attr("opacity", scatterDotRegOpac)
                .attr("stroke","none")
                .attr("r", regR)
              // authors nodes and rects
              d3.selectAll(".collab-rect")
                .attr("opacity", 1)
              d3.selectAll(".collab-node")
                .attr("opacity", 1)
                .attr("stroke","none")
              //authors name
              d3.selectAll(".author-name")
                .attr("opacity", 1)
                .attr("font-size", 11)
              //disappear tooltip
              d3.select("#title-tooltip").transition().style("opacity",0);
              d3.select("#title-tooltip").html("");

              //disappear popup
              var popup = document.getElementsByClassName("popup")[0];
              
              if(typeof popup !== null && popup !== 'undefined' ){
                    popup.classList.remove("popup-show");
                }
            })

            imagesGroup.append("line")
              .attr("x1",function(d) { return x(1990); })
              .attr("x2",function(d) { return x(2020);})
              .attr("y1",function(d) { return height3 + 50 + bookHeight * resizeScale + bookGap })
              .attr("y2",function(d) { return height3 + 50 + bookHeight * resizeScale + bookGap})
              .attr("stroke","#000")
              .attr("stroke-width",1)
              .attr("fill","none")
              .style("stroke-dasharray", ("3, 3"));

          //////////////////////
          //Paper scatter plot//
          //////////////////////
          linesGroup.selectAll("dot")
              .data(data)
            .enter().append("circle")
              .attr("r", regR)
              .attr("cx", function(d) { return x(d.year); })
              .attr("cy", function(d) {
                if(Number.isNaN(d.citations) == true || d.citations == undefined)
                {return 1;}
                else{return y2(d.citations)};
              })
              .style("fill", "#ccc")
              .attr("opacity", scatterDotRegOpac)
              // .attr("class","paper")
              .attr("title",function(d){return d.title})
              .attr("class",function(d){
                if(d.title!=undefined){
                  var id = titleToId(d.title);
                  return "paper " + id+"-scatter";
                }
              })
            .on("mouseover",function(d){
              d3.selectAll(".line").attr("opacity", 0.1)

              d3.select(this)
              .attr("stroke","#000").attr("r", selR).attr("opacity", 1)
              const title = d.title;
              // if there are corresponding img
              const imgCondition = d3.selectAll("."+titleToId(title)+"-img")["_groups"][0].length
              if(imgCondition != 0){
                d3.selectAll(".books-and-pics").attr("opacity", 0.1) 
                d3.selectAll(".journal").attr("opacity", 0.1) 
                d3.selectAll("."+titleToId(title)+"-img")
                  .attr("stroke","#000").attr("stroke-width",2)
                  .attr("opacity", 1)
              }
              
              // check if authors exist
              const authorCondition = d3.selectAll("."+titleToId(title)+"-collab-node")["_groups"][0].length
              if (authorCondition != 0){
                // disappear all authors
                d3.selectAll(".collab-rect").attr("opacity", 0.3)
                d3.selectAll(".collab-node").attr("opacity", 0.1)
                d3.selectAll(".author-name").attr("opacity", 0.2)

                // highlight selected authors node
                d3.selectAll("."+titleToId(title)+"-collab-node")
                .attr("opacity", 1)
                .attr("stroke","#000").attr("stroke-width",2)

                // highlight selected authors name
                d3.selectAll("."+titleToId(title)+"-author-name")
                .attr("opacity", 1).attr("font-size", 15)
              }

              const mouseX = d3.event.pageX + 10;
              const mouseY = d3.event.pageY;
              d3.select("#title-tooltip").append("text").text(title);
              d3.select("#title-tooltip").style("left", `${mouseX}px`).style("top", `${mouseY}px`).transition().duration(500).style("opacity",1);
            })
            .on("click", function(d){
              var popup = document.getElementsByClassName("popup")[0];
              
              if(typeof popup !== null && popup !== 'undefined' ){
                    popup.classList.add("popup-show");
                }
              const title = d.title;
             
              let selImg;
                  if (data.filter(d => d.title == title)[0].img !== undefined){
                    selImg = data.filter(d => d.title == title)[0].img || data.filter(d => d.title == title)[0].cover
                    d3.select("#popup_img").attr("src", `${filepath}${selImg}`).attr("opacity","1")
                  } else{
                    d3.select("#popup_img").attr("opacity","0")
                  }

              const authors = data.filter(d => d.title == title)[0].authors.join(", ");
              const abstract = data.filter(d => d.title == title)[0].abstract;
              d3.select("#popup_title").html(title);
              d3.select("#popup_authorName").html(authors);
              d3.select("#popup_abstract_paragraph").html(abstract)
              
              d3.select(this).attr("stroke","#000").attr("stroke-width",2).attr("r", selR)
              d3.select("#title-tooltip").transition().style("opacity",0);
              d3.select("#title-tooltip").html("");
            })
            .on("mouseout",function(d){
              d3.select(this).attr("stroke","none").attr("r", regR).attr("opacity", scatterDotRegOpac)

              d3.selectAll(".books-and-pics")
                .attr("opacity", 1)
                .attr("stroke","none")
                .attr("stroke-width",0)
              d3.selectAll(".journal")
                .attr("opacity", 1)
                .attr("stroke","none")
                .attr("stroke-width",0)

              // authors nodes and rects
              d3.selectAll(".collab-rect")
                .attr("opacity", 1)
              d3.selectAll(".collab-node")
                .attr("opacity", 1)
                .attr("stroke","none")
              //authors name
              d3.selectAll(".author-name")
                .attr("opacity", 1)
                .attr("font-size", 11)

              d3.selectAll(".line").attr("opacity", 1)

              var popup = document.getElementsByClassName("popup")[0];
              
              if(typeof popup !== null && popup !== 'undefined' ){
                    popup.classList.remove("popup-show");
                }
              d3.select("#title-tooltip").transition().style("opacity",0);
              d3.select("#title-tooltip").html("");
            })

         
          ///////////////////////
          //The TWO LINE CHARTS//
          ///////////////////////
          for(t=x.domain()[0];t<x.domain()[1];t++){
              yearly[t] = {};
              var cownt = 0;
              var ac = 0;
              for(d in data){
                if(data[d].year == t){
                  cownt++;
                  ac+=data[d].authors.length;
                }
              }
            // console.log(cownt,ac);
            yearly[t]["papers"] = cownt;
            yearly[t]["people"] = ac;
          }

          var line = d3.line()
            .x(function(d) {return x(d.key); })
            .y(function(d) { return yLine(d.value.papers); })
            .curve(d3.curveCatmullRom);
          var line2 = d3.line()
            .x(function(d) {return x(d.key); })
            .y(function(d) { return yLine2(d.value.people); })
            .curve(d3.curveCatmullRom);

          linesGroup.append("path")
            .datum(d3.entries(yearly))
            .attr("class","line")
            .attr("d",line) // # of papers
            .style("fill","none")
            .attr("stroke", "#000")
            .attr("stroke-width",2)
            .attr("opacity", lineRegOpac)

          linesGroup.append("path")
            .datum(d3.entries(yearly))
            .attr("class","line")
            .attr("d",line2) // # of participants
            .style("fill","none")
            .attr("stroke", function(){return getRandomColor();})
            .attr("stroke-width",2)
            .attr("opacity", lineRegOpac)

          //get time data for collaborator timeline, cross with publication data
          var count = 0;
          var tempA = {};
          for(j=0;j<data.length;j++){
            if(data[j].authors!= undefined && data[j].authors!= null){
              var yr = data[j].year;
              for(i=0;i<data[j].authors.length;i++){
              // for(i=0;i<10;i++){
                var au = data[j].authors[i];
                if(au!=undefined && au.includes("Albertlaszlo") == false && au.includes("Albert-") == false && data2[au]!=undefined){
                  if(data2[au].status != "c" && data2[au].status != "" && data2[au].status != "x" && data2[au].status != "n" && data2[au].status != "a"){
                    if(authTracks[au]==undefined){
                      if( Number.isNaN(yr) == false && Number.isNaN(data[j].citations) == false && yr!=1970){
                        count++;
                        tempA[au] = count;
                        authTracks[au] = [];
                        authTracks[au].push({"x":yr,"y":data[j].citations, "ix":count, "t":data[j].title});
                      }
                    }else{
                      
                      var result = authTracks[au].filter(obj => {
                        if (obj.x === yr && obj.t.toLowerCase() === data[j].title.toLowerCase()){
                           obj.w++;
                           return obj.x === yr && obj.t.toLowerCase() == data[j].title.toLowerCase()
                        }
                      });
                    
                      if(result.length == 0){
                        if( Number.isNaN(yr) == false && Number.isNaN(data[j].citations) == false && yr!=1970){
                          authTracks[au].push({"x":yr,"y":data[j].citations, "ix":tempA[au], "t":data[j].title});
                        }
                      } 
                    }
                   }//if status
                }
              }
            }
          }
          // console.log(authTracks)

          var tempB = Object.keys(tempA);
          //sort by longest range
          //tempB.sort((a, b) => ((authTracks[a][authTracks[a].length-1].x - authTracks[a][0].x) > (authTracks[b][authTracks[b].length-1].x - authTracks[b][0].x)) ? 1 : -1);
          //sort by earliest appearance in timeline
          tempB.sort((a, b) => (authTracks[a][0].x > authTracks[b][0].x) ? 1 : -1);
          //sort by number of publications
          // tempB.sort((a, b) => (authTracks[a].length < authTracks[b].length) ? 1 : -1);
          // console.log(tempB)
          // var uu = [];
          //   for(z=0;z<tempB.length;z++){
          //     var u = unicodeLiteral(tempB[z]);
          //     uu.push(u)
          //   }
          // console.log(uu);

          y3.domain([1, Object.keys(authTracks).length]);
          for(auth in authTracks) {
            var c = getRandomColor();
            var status = colors[data2[auth].status];
            // if(authTracks[auth].length > 1){
              authTracks[auth].sort((a, b) => (a.x > b.x) ? 1 : -1);

              //draw collaborator bars
              linesGroup.append("rect")
              .attr("class", "collab-rect")
              .attr("x",function(){return x(authTracks[auth][0].x)})
              .attr("y",function(){return y3(tempB.indexOf(auth))})
              .attr("width",function(){
                var l = authTracks[auth].length-1;
                return x((authTracks[auth][l].x)) - x((authTracks[auth][0].x))+2
              })
              .attr("height",2)
              .attr("fill", status);
            // }
            //append nodes
            linesGroup.selectAll("dot")
              .data(authTracks[auth])
            .enter().append("circle")
              .attr("title",function(d){
                  return d.t
                })
              .attr("class",function(d){
                if(d.t!=undefined){
                  var t = titleToId(d.t);
                  return `collab-node ${t}-collab-node`;
                }else{
                  return `collab-node ${auth+d.x}-collab-node`;
                }})
              .attr("r", function(d){if(d.y == 0){return 3;}else {return ySize(d.y);}})
              .attr("cx", function(d) { return x(d.x); })
              .attr("cy", function(d) {return y3(tempB.indexOf(auth))+1; })
              .on('mouseover', function(d){
                // disappear everything
                d3.selectAll(".collab-rect").attr("opacity", 0.3)
                d3.selectAll(".collab-node").attr("opacity", 0.1)
                d3.selectAll(".author-name").attr("opacity", 0.2)
                d3.selectAll(".line").attr("opacity", 0.1)

                let selected;
                if (d.t != undefined){
                  selected = titleToId(d.t)
                } else {
                  selected = auth+d.x;
                }
                // selected authors nodes 
                d3.selectAll("."+selected+"-collab-node")
                  .attr("stroke", "#000")
                  .attr("opacity", 1)
                // selected authors names
                d3.selectAll("."+selected+"-author-name")
                  .attr("opacity", 1)
                
                const imgCondition = d3.selectAll("."+selected+"-img")["_groups"][0].length
                if (imgCondition != 0){
                  d3.selectAll(".books-and-pics").attr("opacity", 0.1)
                  d3.selectAll(".journal").attr("opacity", 0.1) 
                  d3.selectAll("."+selected+"-img").attr("opacity", 1)
                }

                const scatterCondition = d3.selectAll("."+selected+"-scatter")["_groups"][0].length
                if (scatterCondition != 0){
                  d3.selectAll("."+selected+"-scatter")
                    .attr("stroke","#000")
                    .attr("stroke-width",2)
                    .attr("r", selR)
                    .attr("opacity",1)
                }

                //title tooltip
                var cx = x(d.x)+80;
                var cy = d3.select(this).attr("cy")
                d3.select("#dot-tooltip").append("text").text(function(){return d.t;});
                d3.select("#dot-tooltip").style("left",`${cx}px`).style("top", `${cy}px`).style("opacity",1);
              })
              .on("click", function(d){

                  // disappear title tooltip
                  d3.select("#dot-tooltip").transition().style("opacity",0);
                  d3.select("#dot-tooltip").html("");

                  let selected;
                  if (d.t != undefined){
                    selected = titleToId(d.t)
                  } else {
                    selected = auth+d.x;
                  }
                  
                  var popup = document.getElementsByClassName("popup")[0];
                  
                  if(typeof popup !== null && popup !== 'undefined' ){
                        popup.classList.add("popup-show");
                    }

                  const title = d.t || autho+d.x
                  let selImg;
                  if (data.filter(d => d.title == title)[0].img !== undefined){
                    selImg = data.filter(d => d.title == title)[0].img || data.filter(d => d.title == title)[0].cover
                    d3.select("#popup_img").attr("src", `${filepath}${selImg}`).attr("opacity","1")
                  } else{
                    d3.select("#popup_img").attr("opacity","0")
                  }
                  const authors = data.filter(d => d.title == title)[0].authors.join(", ");
                  const abstract = data.filter(d => d.title == title)[0].abstract;

                  d3.select("#popup_title").html(title);
                  d3.select("#popup_authorName").html(authors);
                  d3.select("#popup_abstract_paragraph").html(abstract)
            })
              .on('mouseout', function(d){

                d3.selectAll(".line").attr("opacity", 1)

                  d3.selectAll(".collab-node").attr("stroke", "none").attr("opacity", 1)
                  d3.selectAll(".author-name").attr("opacity", 1).attr("font-size", 11)
                  d3.selectAll(".books-and-pics").attr("opacity", 1) 
                  d3.selectAll(".journal")
                  .attr("opacity", 1)
                  .attr("stroke","none")
                  .attr("stroke-width",0)


                d3.selectAll(".paper")
                    .attr("stroke","none")
                    .attr("r", regR)
                    .attr("opacity", scatterDotRegOpac)

                d3.select("#dot-tooltip").style("opacity",0);
                d3.select("#dot-tooltip").html("");

                var popup = document.getElementsByClassName("popup")[0];
              
                if(typeof popup !== null && popup !== 'undefined' ){
                      popup.classList.remove("popup-show");
                  }
                
              })
              .style("fill",status)
              .attr("stroke",status);

              //add collaborator names
            // if(authTracks[auth].length > 1){
              var l = authTracks[auth].length-1;
              linesGroup.append("text")
                // .attr("class", () => "author-name "+ titleToId(authTracks[auth][0].t)+"-author-name")
                .attr("class", () => {
                  let classList = [];
                  for (let i = 0; i < authTracks[auth].length; i++){
                    classList.push(titleToId(authTracks[auth][i].t)+"-author-name")
                  }
                  classList.push("author-name")
                  classList = classList.join("  ");
                  return classList
                })
                .attr("x", function(){return x(authTracks[auth][0].x)-15})
                // .attr("x",function(){
                //   var l = authTracks[auth].length-1;
                //   var f = x(authTracks[auth][0].x);
                //   var e = x(authTracks[auth][l].x);
                //   return ((x(e)-x(f)+1)/2)+f;
                // })
                .attr("y", function(){return y3(tempB.indexOf(auth))+3})
                .text(function(){return auth})
                .attr("text-anchor","end")
                .attr("font-size", 10)
                .attr("fill", "#000")
            // }
          }

          linesGroup.append("g")
              .attr("transform", "translate(0," + height2 + ")")
              .call(d3.axisBottom(x).tickFormat(d => d));
          linesGroup.append("g")
              .attr("transform", "translate(0," + -20 + ")")
              .call(d3.axisBottom(x).tickFormat(d => d));
          linesGroup.append("g")
                  .attr("transform", "translate(0," + height3 + ")")
                  .call(d3.axisBottom(x).tickFormat(d => d));
        });
      });

      /* Creates a uppercase hex number with at least length digits from a given number */
      function fixedHex(number, length){
          var str = number.toString(16).toUpperCase();
          while(str.length < length)
              str = "0" + str;
          return str;
      }

      /* Creates a unicode literal based on the string */
      function unicodeLiteral(str){
          var i;
          var result = "";
          for( i = 0; i < str.length; ++i){
              /* You should probably replace this by an isASCII test */
              if(str.charCodeAt(i) > 126 || str.charCodeAt(i) < 32)
                  result += "\\u" + fixedHex(str.charCodeAt(i),4);
              else
                  result += str[i];
          }

          return result;
      }

      function getRandomColor() {
        var letters = 'ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 6)];
        }
        return color;
      }

      function titleToId(title){
        var t = title.replace(/ /g,"-").toLowerCase();
        t=t.replace(/:/g,"-");
        t=t.replace(/\?/g,"-");
        t=t.replace(/\//g,"-");
        t=t.replace(/'/g,"-");
        t=t.replace(/"/g,'-');
        t=t.replace(/,/g,"-");
        t=t.replace(/@/g,"-");
        t=t.replace(/;/g,"-");
        t=t.replace(/\./g,"");
        t=t.replace(/\(/g,"-");
        t=t.replace(/\)/g,"-");
        return t;
      }

      function imgToDefs(img,id,r,h){
        defs.append("svg:pattern")
        .attr("id", id+"img")
        .attr("width", 1)
        .attr("height", function(){return 1*(h/r);})
        // .attr("patternUnits", "userSpaceOnUse")
        .append("svg:image")
        .attr("xlink:href", filepath+img)
        .attr("width", r)
        .attr("height", h)
        .attr("x", 0)
        .attr("y", 0);
      }

      // d3.select("#generate")
      //     .on("click", writeDownloadLink);
      // function writeDownloadLink(){
      //     try {
      //         var isFileSaverSupported = !!new Blob();
      //     } catch (e) {
      //         alert("blob not supported");
      //     }
      //     var html = graph
      //         .attr("title", "test2")
      //         .attr("version", 1.1)
      //         .attr("xmlns", "http://www.w3.org/2000/svg")
      //         .node().outerHTML;
      //     var blob = new Blob([html], {type: "image/svg+xml"});
      //     saveAs(blob, "viz.svg");
      // };
    </script>
  </body>
</html>
